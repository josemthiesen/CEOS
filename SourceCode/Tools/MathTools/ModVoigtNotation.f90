!##################################################################################################
!                                   VOIGT NOTATION MODULE
!
! Tensorial Operations in Euclidean Space 3D using Voigt Notation
!--------------------------------------------------------------------------------------------------
!
! Remark: Operations used in this module were implemented following
!         the mapping shown in Appendix E of Jog(2007).
!
! References:
!
!   [1] JOG, C. Foundations and Applications of Mechnics Volume I: Continuum Mechanics.
!       2 edition. ed. [S.l.]: Alpha Science Intl Ltd, 2007. I. 510 p.
!--------------------------------------------------------------------------------------------------
!
! Variables:
!--------------------------------------------------------------------------------------------------
! s                       = Scalars
! A                       = Second Order Tensors
! C                       = Forth Order Tensors
! A_voigt,B_voigt         = Second Order Tensors in Non-Symmetric Voigt Notation
! A_voigt_sym,B_voigt_sym = Second Order Tensors in Symmetric Voigt Notation
! C_voigt,D_voigt         = Forth Order Tensors in Non-Symmetric Voigt Notation
! C_voigt_sym,D_voigt_sym = Forth Order Tensors in Symmetric Voigt Notation
!--------------------------------------------------------------------------------------------------
!
! Functions:
!--------------------------------------------------------------------------------------------------
! "OperationName"Voigt    - Operations using non-symmetric mapping
! "OperationName"VoigtSym - Operations using symmetric mapping
!--------------------------------------------------------------------------------------------------
!
! Mappings:
!
!    A           = VoigtToTensor2(A_voigt)
!    A           = VoigtSymToTensor2(A_voigt_sym)
!    A_voigt     = Tensor2ToVoigt(A)
!    A_voigt_sym = Tensor2ToVoigtSym(A)
!    C_voigt     = Tensor4ToVoigt(C)
!    C_voigt_sym = Tensor4ToVoigtSym(C)
!    C_voigt_sym = IdentityT4SymVoigtSym()
!    C_voigt_sym = MaterialToSpatialModulusVoigtSym(D_voigt_sym,A)
!
!
! Operations:
!
!    C_voigt_sym = BallVoigtSym(A_voigt_sym,B_voigt_sym)
!    C_voigt_sym = SquareVoigtSym(A_voigt_sym,B_voigt_sym)
!    s           = DoubleContractionT2T2VoigtSym(A_voigt_sym,B_voigt_sym)
!    A_voigt_sym = DoubleContractionT4T2VoigtSym(C_voigt_sym,B_voigt_sym)
!    C_voigt_sym = DoubleContractionT4T4VoigtSym(C_voigt_sym,D_voigt_sym)
!
!--------------------------------------------------------------------------------------------------
!
!##################################################################################################
module ModVoigtNotation

    use ModTensorAlgebra


    contains

        !##################################################################################################
        !
        ! Transformations: Tensors to Voigt | Voigt to Tensors
        !
        !##################################################################################################
        !==========================================================================================
        function Tensor2ToVoigt (A) result( T )

            implicit none
            real(8),dimension(:,:)       :: A
            real(8),dimension(9)         :: T

                T(1) = A(1,1)
                T(2) = A(2,1)
                T(3) = A(3,1)
                T(4) = A(1,2)
                T(5) = A(2,2)
                T(6) = A(3,2)
                T(7) = A(1,3)
                T(8) = A(2,3)
                T(9) = A(3,3)

        end function
        !==========================================================================================

        !==========================================================================================
        function VoigtToTensor2 (T) result( A)

            implicit none
            real(8),dimension(:)         :: T
            real(8),dimension(3,3)       :: A

                A(1,1) = T(1)
                A(2,1) = T(2)
                A(3,1) = T(3)
                A(1,2) = T(4)
                A(2,2) = T(5)
                A(3,2) = T(6)
                A(1,3) = T(7)
                A(2,3) = T(8)
                A(3,3) = T(9)

        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor2ToVoigtSym (A) result( T )

            implicit none
            real(8),dimension(:,:)       :: A
            real(8),dimension(6)         :: T

                T(1) = A(1,1)
                T(2) = A(2,2)
                T(3) = A(3,3)
                T(4) = A(1,2)
                T(5) = A(2,3)
                T(6) = A(1,3)

        end function
        !==========================================================================================
              
        !==========================================================================================
        function VoigtSymToTensor2 (T) result( A )

            implicit none
            real(8),dimension(:)         :: T
            real(8),dimension(3,3)       :: A

                A(1,1) = T(1)
                A(2,2) = T(2)
                A(3,3) = T(3)
                A(1,2) = T(4)
                A(2,1) = T(4)
                A(2,3) = T(5)
                A(3,2) = T(5)
                A(1,3) = T(6)
                A(3,1) = T(6)

        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor2VoigtToTensor2VoigtSym (A) result( T )

            implicit none
            real(8),dimension(9)       :: A
            real(8),dimension(6)       :: T

                T(1) = A(1)
                T(2) = A(5)
                T(3) = A(9)
                T(4) = A(4)
                T(5) = A(8)
                T(6) = A(3)

        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor2VoigtSymToTensor2Voigt (A) result( T )

            implicit none
            real(8),dimension(6)       :: A
            real(8),dimension(9)       :: T

                T(1) = A(1)
                T(2) = A(4)
                T(3) = A(6)
                T(4) = A(4)
                T(5) = A(2)
                T(6) = A(5)
                T(7) = A(6)
                T(8) = A(5)
                T(9) = A(3)


        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor4ToVoigt(C) result(D)

            implicit none
            real(8),dimension(3,3,3,3) :: C
            real(8),dimension(9,9)     :: D

              D(1,1) = C(1,1,1,1)
              D(1,2) = C(1,1,2,1)
              D(1,3) = C(1,1,3,1)
              D(1,4) = C(1,1,1,2)
              D(1,5) = C(1,1,2,2)
              D(1,6) = C(1,1,3,2)
              D(1,7) = C(1,1,1,3)
              D(1,8) = C(1,1,2,3)
              D(1,9) = C(1,1,3,3)
              D(2,1) = C(2,1,1,1)
              D(2,2) = C(2,1,2,1)
              D(2,3) = C(2,1,3,1)
              D(2,4) = C(2,1,1,2)
              D(2,5) = C(2,1,2,2)
              D(2,6) = C(2,1,3,2)
              D(2,7) = C(2,1,1,3)
              D(2,8) = C(2,1,2,3)
              D(2,9) = C(2,1,3,3)
              D(3,1) = C(3,1,1,1)
              D(3,2) = C(3,1,2,1)
              D(3,3) = C(3,1,3,1)
              D(3,4) = C(3,1,1,2)
              D(3,5) = C(3,1,2,2)
              D(3,6) = C(3,1,3,2)
              D(3,7) = C(3,1,1,3)
              D(3,8) = C(3,1,2,3)
              D(3,9) = C(3,1,3,3)
              D(4,1) = C(1,2,1,1)
              D(4,2) = C(1,2,2,1)
              D(4,3) = C(1,2,3,1)
              D(4,4) = C(1,2,1,2)
              D(4,5) = C(1,2,2,2)
              D(4,6) = C(1,2,3,2)
              D(4,7) = C(1,2,1,3)
              D(4,8) = C(1,2,2,3)
              D(4,9) = C(1,2,3,3)
              D(5,1) = C(2,2,1,1)
              D(5,2) = C(2,2,2,1)
              D(5,3) = C(2,2,3,1)
              D(5,4) = C(2,2,1,2)
              D(5,5) = C(2,2,2,2)
              D(5,6) = C(2,2,3,2)
              D(5,7) = C(2,2,1,3)
              D(5,8) = C(2,2,2,3)
              D(5,9) = C(2,2,3,3)
              D(6,1) = C(3,2,1,1)
              D(6,2) = C(3,2,2,1)
              D(6,3) = C(3,2,3,1)
              D(6,4) = C(3,2,1,2)
              D(6,5) = C(3,2,2,2)
              D(6,6) = C(3,2,3,2)
              D(6,7) = C(3,2,1,3)
              D(6,8) = C(3,2,2,3)
              D(6,9) = C(3,2,3,3)
              D(7,1) = C(1,3,1,1)
              D(7,2) = C(1,3,2,1)
              D(7,3) = C(1,3,3,1)
              D(7,4) = C(1,3,1,2)
              D(7,5) = C(1,3,2,2)
              D(7,6) = C(1,3,3,2)
              D(7,7) = C(1,3,1,3)
              D(7,8) = C(1,3,2,3)
              D(7,9) = C(1,3,3,3)
              D(8,1) = C(2,3,1,1)
              D(8,2) = C(2,3,2,1)
              D(8,3) = C(2,3,3,1)
              D(8,4) = C(2,3,1,2)
              D(8,5) = C(2,3,2,2)
              D(8,6) = C(2,3,3,2)
              D(8,7) = C(2,3,1,3)
              D(8,8) = C(2,3,2,3)
              D(8,9) = C(2,3,3,3)
              D(9,1) = C(3,3,1,1)
              D(9,2) = C(3,3,2,1)
              D(9,3) = C(3,3,3,1)
              D(9,4) = C(3,3,1,2)
              D(9,5) = C(3,3,2,2)
              D(9,6) = C(3,3,3,2)
              D(9,7) = C(3,3,1,3)
              D(9,8) = C(3,3,2,3)
              D(9,9) = C(3,3,3,3)

        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor4ToVoigtSym(C) result(D)

            implicit none
            real(8),dimension(3,3,3,3) :: C
            real(8),dimension(6,6)     :: D

              D(1,1) = C(1,1,1,1)
              D(1,2) = C(1,1,2,2)
              D(1,3) = C(1,1,3,3)
              D(1,4) = C(1,1,1,2)
              D(1,5) = C(1,1,2,3)
              D(1,6) = C(1,1,1,3)
              D(2,1) = C(2,2,1,1)
              D(2,2) = C(2,2,2,2)
              D(2,3) = C(2,2,3,3)
              D(2,4) = C(2,2,1,2)
              D(2,5) = C(2,2,2,3)
              D(2,6) = C(2,2,1,3)
              D(3,1) = C(3,3,1,1)
              D(3,2) = C(3,3,2,2)
              D(3,3) = C(3,3,3,3)
              D(3,4) = C(3,3,1,2)
              D(3,5) = C(3,3,2,3)
              D(3,6) = C(3,3,1,3)
              D(4,1) = C(1,2,1,1)
              D(4,2) = C(1,2,2,2)
              D(4,3) = C(1,2,3,3)
              D(4,4) = C(1,2,1,2)
              D(4,5) = C(1,2,2,3)
              D(4,6) = C(1,2,1,3)
              D(5,1) = C(2,3,1,1)
              D(5,2) = C(2,3,2,2)
              D(5,3) = C(2,3,3,3)
              D(5,4) = C(2,3,1,2)
              D(5,5) = C(2,3,2,3)
              D(5,6) = C(2,3,1,3)
              D(6,1) = C(3,1,1,1)
              D(6,2) = C(3,1,2,2)
              D(6,3) = C(3,1,3,3)
              D(6,4) = C(3,1,1,2)
              D(6,5) = C(3,1,2,3)
              D(6,6) = C(3,1,1,3)

        end function
        !==========================================================================================

        !==========================================================================================
        function Tensor4VoigtToTensor4VoigtSym(A) result(T4sym)

            implicit none
            real(8),dimension(9,9) :: A
            real(8),dimension(6,6) :: T4sym

              T4sym(1,1) = A(1,1)
              T4sym(1,2) = A(1,5)
              T4sym(1,3) = A(1,9)
              T4sym(1,4) = A(1,4)
              T4sym(1,5) = A(1,8)
              T4sym(1,6) = A(1,7)
              T4sym(2,1) = A(5,1)
              T4sym(2,2) = A(5,5)
              T4sym(2,3) = A(5,9)
              T4sym(2,4) = A(5,4)
              T4sym(2,5) = A(5,8)
              T4sym(2,6) = A(5,7)
              T4sym(3,1) = A(9,1)
              T4sym(3,2) = A(9,5)
              T4sym(3,3) = A(9,9)
              T4sym(3,4) = A(9,4)
              T4sym(3,5) = A(9,8)
              T4sym(3,6) = A(9,7)
              T4sym(4,1) = A(4,1)
              T4sym(4,2) = A(4,5)
              T4sym(4,3) = A(4,9)
              T4sym(4,4) = A(4,4)
              T4sym(4,5) = A(4,8)
              T4sym(4,6) = A(4,7)
              T4sym(5,1) = A(8,1)
              T4sym(5,2) = A(8,5)
              T4sym(5,3) = A(8,9)
              T4sym(5,4) = A(8,4)
              T4sym(5,5) = A(8,8)
              T4sym(5,6) = A(8,7)
              T4sym(6,1) = A(7,1)
              T4sym(6,2) = A(7,5)
              T4sym(6,3) = A(7,9)
              T4sym(6,4) = A(7,4)
              T4sym(6,5) = A(7,8)
              T4sym(6,6) = A(7,7)

        end function
        !==========================================================================================


        !##################################################################################################
        !
        ! Operations using non-symmetric mapping
        !
        !##################################################################################################
        !==========================================================================================
        function DeterminantT2Voigt(Av) result(detA)

            implicit none
            real(8) :: detA
            real(8),dimension(9) :: Av

            detA = Av(1)*Av(5)*Av(9) - Av(1)*Av(8)*Av(6) + Av(2)*Av(6)*Av(7) - &
                   Av(2)*Av(4)*Av(9) + Av(3)*Av(4)*Av(8) - Av(3)*Av(5)*Av(7)

        end function
        !==========================================================================================

        !==========================================================================================
        function TransposeT2Voigt(Av) result(At)

            implicit none
            real(8),dimension(9) :: Av, At

              At(1) = Av(1)
              At(2) = Av(4)
              At(3) = Av(7)
              At(4) = Av(2)
              At(5) = Av(5)
              At(6) = Av(8)
              At(7) = Av(3)
              At(8) = Av(6)
              At(9) = Av(9)

        end function
        !==========================================================================================

        !==========================================================================================
        function InverseT2Voigt(Av) result(invA)

            implicit none
            real(8),dimension(9) :: Av, invA

              invA(1) = Av(5) * Av(9) - Av(8) * Av(6)
              invA(2) = Av(3) * Av(8) - Av(2) * Av(9)
              invA(3) = -Av(3) * Av(5) + Av(2) * Av(6)
              invA(4) = Av(6) * Av(7) - Av(4) * Av(9)
              invA(5) = -Av(3) * Av(7) + Av(1) * Av(9)
              invA(6) = Av(3) * Av(4) - Av(1) * Av(6)
              invA(7) = Av(4) * Av(8) - Av(5) * Av(7)
              invA(8) = Av(2) * Av(7) - Av(1) * Av(8)
              invA(9) = -Av(2) * Av(4) + Av(1) * Av(5)

              invA = invA/DeterminantT2Voigt(Av)

        end function
        !==========================================================================================

        !==========================================================================================
        function SingleContractionT2T2Voigt(Av,Bv) result(AB)

            implicit none
            real(8),dimension(9) :: Av,Bv,AB

              AB(1) = Av(1) * Bv(1) + Av(4) * Bv(2) + Av(7) * Bv(3)
              AB(2) = Av(2) * Bv(1) + Av(5) * Bv(2) + Av(8) * Bv(3)
              AB(3) = Av(3) * Bv(1) + Av(6) * Bv(2) + Av(9) * Bv(3)
              AB(4) = Av(1) * Bv(4) + Av(4) * Bv(5) + Av(7) * Bv(6)
              AB(5) = Av(2) * Bv(4) + Av(5) * Bv(5) + Av(8) * Bv(6)
              AB(6) = Av(3) * Bv(4) + Av(6) * Bv(5) + Av(9) * Bv(6)
              AB(7) = Av(1) * Bv(7) + Av(4) * Bv(8) + Av(7) * Bv(9)
              AB(8) = Av(2) * Bv(7) + Av(5) * Bv(8) + Av(8) * Bv(9)
              AB(9) = Av(3) * Bv(7) + Av(6) * Bv(8) + Av(9) * Bv(9)

        end function
        !==========================================================================================

        !==========================================================================================
        function BallVoigt(Av,Bv) result(AballB)

            implicit none
            real(8),dimension(9)   :: Av,Bv
            real(8),dimension(9,9) :: AballB

              AballB(1,1) = Av(1) * Bv(1)
              AballB(1,2) = Av(1) * Bv(2)
              AballB(1,3) = Av(1) * Bv(3)
              AballB(1,4) = Av(1) * Bv(4)
              AballB(1,5) = Av(1) * Bv(5)
              AballB(1,6) = Av(1) * Bv(6)
              AballB(1,7) = Av(1) * Bv(7)
              AballB(1,8) = Av(1) * Bv(8)
              AballB(1,9) = Av(1) * Bv(9)
              AballB(2,1) = Av(2) * Bv(1)
              AballB(2,2) = Av(2) * Bv(2)
              AballB(2,3) = Av(2) * Bv(3)
              AballB(2,4) = Av(2) * Bv(4)
              AballB(2,5) = Av(2) * Bv(5)
              AballB(2,6) = Av(2) * Bv(6)
              AballB(2,7) = Av(2) * Bv(7)
              AballB(2,8) = Av(2) * Bv(8)
              AballB(2,9) = Av(2) * Bv(9)
              AballB(3,1) = Av(3) * Bv(1)
              AballB(3,2) = Av(3) * Bv(2)
              AballB(3,3) = Av(3) * Bv(3)
              AballB(3,4) = Av(3) * Bv(4)
              AballB(3,5) = Av(3) * Bv(5)
              AballB(3,6) = Av(3) * Bv(6)
              AballB(3,7) = Av(3) * Bv(7)
              AballB(3,8) = Av(3) * Bv(8)
              AballB(3,9) = Av(3) * Bv(9)
              AballB(4,1) = Av(4) * Bv(1)
              AballB(4,2) = Av(4) * Bv(2)
              AballB(4,3) = Av(4) * Bv(3)
              AballB(4,4) = Av(4) * Bv(4)
              AballB(4,5) = Av(4) * Bv(5)
              AballB(4,6) = Av(4) * Bv(6)
              AballB(4,7) = Av(4) * Bv(7)
              AballB(4,8) = Av(4) * Bv(8)
              AballB(4,9) = Av(4) * Bv(9)
              AballB(5,1) = Av(5) * Bv(1)
              AballB(5,2) = Av(5) * Bv(2)
              AballB(5,3) = Av(5) * Bv(3)
              AballB(5,4) = Av(5) * Bv(4)
              AballB(5,5) = Av(5) * Bv(5)
              AballB(5,6) = Av(5) * Bv(6)
              AballB(5,7) = Av(5) * Bv(7)
              AballB(5,8) = Av(5) * Bv(8)
              AballB(5,9) = Av(5) * Bv(9)
              AballB(6,1) = Av(6) * Bv(1)
              AballB(6,2) = Av(6) * Bv(2)
              AballB(6,3) = Av(6) * Bv(3)
              AballB(6,4) = Av(6) * Bv(4)
              AballB(6,5) = Av(6) * Bv(5)
              AballB(6,6) = Av(6) * Bv(6)
              AballB(6,7) = Av(6) * Bv(7)
              AballB(6,8) = Av(6) * Bv(8)
              AballB(6,9) = Av(6) * Bv(9)
              AballB(7,1) = Av(7) * Bv(1)
              AballB(7,2) = Av(7) * Bv(2)
              AballB(7,3) = Av(7) * Bv(3)
              AballB(7,4) = Av(7) * Bv(4)
              AballB(7,5) = Av(7) * Bv(5)
              AballB(7,6) = Av(7) * Bv(6)
              AballB(7,7) = Av(7) * Bv(7)
              AballB(7,8) = Av(7) * Bv(8)
              AballB(7,9) = Av(7) * Bv(9)
              AballB(8,1) = Av(8) * Bv(1)
              AballB(8,2) = Av(8) * Bv(2)
              AballB(8,3) = Av(8) * Bv(3)
              AballB(8,4) = Av(8) * Bv(4)
              AballB(8,5) = Av(8) * Bv(5)
              AballB(8,6) = Av(8) * Bv(6)
              AballB(8,7) = Av(8) * Bv(7)
              AballB(8,8) = Av(8) * Bv(8)
              AballB(8,9) = Av(8) * Bv(9)
              AballB(9,1) = Av(9) * Bv(1)
              AballB(9,2) = Av(9) * Bv(2)
              AballB(9,3) = Av(9) * Bv(3)
              AballB(9,4) = Av(9) * Bv(4)
              AballB(9,5) = Av(9) * Bv(5)
              AballB(9,6) = Av(9) * Bv(6)
              AballB(9,7) = Av(9) * Bv(7)
              AballB(9,8) = Av(9) * Bv(8)
              AballB(9,9) = Av(9) * Bv(9)

        end function
        !==========================================================================================

        !==========================================================================================
        function SquareVoigt(Av,Bv) result(AsqB)

            implicit none
            real(8),dimension(9)   :: Av,Bv
            real(8),dimension(9,9) :: AsqB

              AsqB(1,1) = Av(1) * Bv(1)
              AsqB(1,2) = Av(4) * Bv(1)
              AsqB(1,3) = Av(7) * Bv(1)
              AsqB(1,4) = Av(1) * Bv(4)
              AsqB(1,5) = Av(4) * Bv(4)
              AsqB(1,6) = Av(7) * Bv(4)
              AsqB(1,7) = Av(1) * Bv(7)
              AsqB(1,8) = Av(4) * Bv(7)
              AsqB(1,9) = Av(7) * Bv(7)
              AsqB(2,1) = Av(2) * Bv(1)
              AsqB(2,2) = Av(5) * Bv(1)
              AsqB(2,3) = Av(8) * Bv(1)
              AsqB(2,4) = Av(2) * Bv(4)
              AsqB(2,5) = Av(5) * Bv(4)
              AsqB(2,6) = Av(8) * Bv(4)
              AsqB(2,7) = Av(2) * Bv(7)
              AsqB(2,8) = Av(5) * Bv(7)
              AsqB(2,9) = Av(8) * Bv(7)
              AsqB(3,1) = Av(3) * Bv(1)
              AsqB(3,2) = Av(6) * Bv(1)
              AsqB(3,3) = Av(9) * Bv(1)
              AsqB(3,4) = Av(3) * Bv(4)
              AsqB(3,5) = Av(6) * Bv(4)
              AsqB(3,6) = Av(9) * Bv(4)
              AsqB(3,7) = Av(3) * Bv(7)
              AsqB(3,8) = Av(6) * Bv(7)
              AsqB(3,9) = Av(9) * Bv(7)
              AsqB(4,1) = Av(1) * Bv(2)
              AsqB(4,2) = Av(4) * Bv(2)
              AsqB(4,3) = Av(7) * Bv(2)
              AsqB(4,4) = Av(1) * Bv(5)
              AsqB(4,5) = Av(4) * Bv(5)
              AsqB(4,6) = Av(7) * Bv(5)
              AsqB(4,7) = Av(1) * Bv(8)
              AsqB(4,8) = Av(4) * Bv(8)
              AsqB(4,9) = Av(7) * Bv(8)
              AsqB(5,1) = Av(2) * Bv(2)
              AsqB(5,2) = Av(5) * Bv(2)
              AsqB(5,3) = Av(8) * Bv(2)
              AsqB(5,4) = Av(2) * Bv(5)
              AsqB(5,5) = Av(5) * Bv(5)
              AsqB(5,6) = Av(8) * Bv(5)
              AsqB(5,7) = Av(2) * Bv(8)
              AsqB(5,8) = Av(5) * Bv(8)
              AsqB(5,9) = Av(8) * Bv(8)
              AsqB(6,1) = Av(3) * Bv(2)
              AsqB(6,2) = Av(6) * Bv(2)
              AsqB(6,3) = Av(9) * Bv(2)
              AsqB(6,4) = Av(3) * Bv(5)
              AsqB(6,5) = Av(6) * Bv(5)
              AsqB(6,6) = Av(9) * Bv(5)
              AsqB(6,7) = Av(3) * Bv(8)
              AsqB(6,8) = Av(6) * Bv(8)
              AsqB(6,9) = Av(9) * Bv(8)
              AsqB(7,1) = Av(1) * Bv(3)
              AsqB(7,2) = Av(4) * Bv(3)
              AsqB(7,3) = Av(7) * Bv(3)
              AsqB(7,4) = Av(1) * Bv(6)
              AsqB(7,5) = Av(4) * Bv(6)
              AsqB(7,6) = Av(7) * Bv(6)
              AsqB(7,7) = Av(1) * Bv(9)
              AsqB(7,8) = Av(4) * Bv(9)
              AsqB(7,9) = Av(7) * Bv(9)
              AsqB(8,1) = Av(2) * Bv(3)
              AsqB(8,2) = Av(5) * Bv(3)
              AsqB(8,3) = Av(8) * Bv(3)
              AsqB(8,4) = Av(2) * Bv(6)
              AsqB(8,5) = Av(5) * Bv(6)
              AsqB(8,6) = Av(8) * Bv(6)
              AsqB(8,7) = Av(2) * Bv(9)
              AsqB(8,8) = Av(5) * Bv(9)
              AsqB(8,9) = Av(8) * Bv(9)
              AsqB(9,1) = Av(3) * Bv(3)
              AsqB(9,2) = Av(6) * Bv(3)
              AsqB(9,3) = Av(9) * Bv(3)
              AsqB(9,4) = Av(3) * Bv(6)
              AsqB(9,5) = Av(6) * Bv(6)
              AsqB(9,6) = Av(9) * Bv(6)
              AsqB(9,7) = Av(3) * Bv(9)
              AsqB(9,8) = Av(6) * Bv(9)
              AsqB(9,9) = Av(9) * Bv(9)


        end function
        !==========================================================================================

        !==========================================================================================
        function DoubleContractionT4T4Voigt(Cv,Dv) result(Ev)

            implicit none
            real(8),dimension(9,9) :: Cv,Dv,Ev

            !Ev = matmul(Cv,Ev)

            call dgemm('N', 'N', 9, 9, 9, 1.0d0, Cv, 9, Dv, 9, 0.0d0, Ev, 9)

        end function
        !==========================================================================================

        !==========================================================================================
        function IdentityT4SymVoigt() result(IsymT4)

            real(8),dimension(9,9) :: IsymT4

              IsymT4 = 0.0d0

              IsymT4(1,1) = 0.1000000000D1
              IsymT4(2,2) = 0.5000000000D0
              IsymT4(2,4) = 0.5000000000D0
              IsymT4(3,3) = 0.5000000000D0
              IsymT4(3,7) = 0.5000000000D0
              IsymT4(4,2) = 0.5000000000D0
              IsymT4(4,4) = 0.5000000000D0
              IsymT4(5,5) = 0.1000000000D1
              IsymT4(6,6) = 0.5000000000D0
              IsymT4(6,8) = 0.5000000000D0
              IsymT4(7,3) = 0.5000000000D0
              IsymT4(7,7) = 0.5000000000D0
              IsymT4(8,6) = 0.5000000000D0
              IsymT4(8,8) = 0.5000000000D0
              IsymT4(9,9) = 0.1000000000D1

        end function
        !==========================================================================================

        !==========================================================================================
        function RightSymmetrizationT4Voigt(A) result(AIsym)

            implicit none
            real(8),dimension(9,9) :: A, AIsym

            ! AIsym = A:Isym

              AIsym(1,1) = A(1,1)
              AIsym(1,2) = 0.50D0 * A(1,2) + 0.50D0 * A(1,4)
              AIsym(1,3) = 0.50D0 * A(1,3) + 0.50D0 * A(1,7)
              AIsym(1,4) = 0.50D0 * A(1,2) + 0.50D0 * A(1,4)
              AIsym(1,5) = A(1,5)
              AIsym(1,6) = 0.50D0 * A(1,6) + 0.50D0 * A(1,8)
              AIsym(1,7) = 0.50D0 * A(1,3) + 0.50D0 * A(1,7)
              AIsym(1,8) = 0.50D0 * A(1,6) + 0.50D0 * A(1,8)
              AIsym(1,9) = A(1,9)
              AIsym(2,1) = A(2,1)
              AIsym(2,2) = 0.50D0 * A(2,2) + 0.50D0 * A(2,4)
              AIsym(2,3) = 0.50D0 * A(2,3) + 0.50D0 * A(2,7)
              AIsym(2,4) = 0.50D0 * A(2,2) + 0.50D0 * A(2,4)
              AIsym(2,5) = A(2,5)
              AIsym(2,6) = 0.50D0 * A(2,6) + 0.50D0 * A(2,8)
              AIsym(2,7) = 0.50D0 * A(2,3) + 0.50D0 * A(2,7)
              AIsym(2,8) = 0.50D0 * A(2,6) + 0.50D0 * A(2,8)
              AIsym(2,9) = A(2,9)
              AIsym(3,1) = A(3,1)
              AIsym(3,2) = 0.50D0 * A(3,2) + 0.50D0 * A(3,4)
              AIsym(3,3) = 0.50D0 * A(3,3) + 0.50D0 * A(3,7)
              AIsym(3,4) = 0.50D0 * A(3,2) + 0.50D0 * A(3,4)
              AIsym(3,5) = A(3,5)
              AIsym(3,6) = 0.50D0 * A(3,6) + 0.50D0 * A(3,8)
              AIsym(3,7) = 0.50D0 * A(3,3) + 0.50D0 * A(3,7)
              AIsym(3,8) = 0.50D0 * A(3,6) + 0.50D0 * A(3,8)
              AIsym(3,9) = A(3,9)
              AIsym(4,1) = A(4,1)
              AIsym(4,2) = 0.50D0 * A(4,2) + 0.50D0 * A(4,4)
              AIsym(4,3) = 0.50D0 * A(4,3) + 0.50D0 * A(4,7)
              AIsym(4,4) = 0.50D0 * A(4,2) + 0.50D0 * A(4,4)
              AIsym(4,5) = A(4,5)
              AIsym(4,6) = 0.50D0 * A(4,6) + 0.50D0 * A(4,8)
              AIsym(4,7) = 0.50D0 * A(4,3) + 0.50D0 * A(4,7)
              AIsym(4,8) = 0.50D0 * A(4,6) + 0.50D0 * A(4,8)
              AIsym(4,9) = A(4,9)
              AIsym(5,1) = A(5,1)
              AIsym(5,2) = 0.50D0 * A(5,2) + 0.50D0 * A(5,4)
              AIsym(5,3) = 0.50D0 * A(5,3) + 0.50D0 * A(5,7)
              AIsym(5,4) = 0.50D0 * A(5,2) + 0.50D0 * A(5,4)
              AIsym(5,5) = A(5,5)
              AIsym(5,6) = 0.50D0 * A(5,6) + 0.50D0 * A(5,8)
              AIsym(5,7) = 0.50D0 * A(5,3) + 0.50D0 * A(5,7)
              AIsym(5,8) = 0.50D0 * A(5,6) + 0.50D0 * A(5,8)
              AIsym(5,9) = A(5,9)
              AIsym(6,1) = A(6,1)
              AIsym(6,2) = 0.50D0 * A(6,2) + 0.50D0 * A(6,4)
              AIsym(6,3) = 0.50D0 * A(6,3) + 0.50D0 * A(6,7)
              AIsym(6,4) = 0.50D0 * A(6,2) + 0.50D0 * A(6,4)
              AIsym(6,5) = A(6,5)
              AIsym(6,6) = 0.50D0 * A(6,6) + 0.50D0 * A(6,8)
              AIsym(6,7) = 0.50D0 * A(6,3) + 0.50D0 * A(6,7)
              AIsym(6,8) = 0.50D0 * A(6,6) + 0.50D0 * A(6,8)
              AIsym(6,9) = A(6,9)
              AIsym(7,1) = A(7,1)
              AIsym(7,2) = 0.50D0 * A(7,2) + 0.50D0 * A(7,4)
              AIsym(7,3) = 0.50D0 * A(7,3) + 0.50D0 * A(7,7)
              AIsym(7,4) = 0.50D0 * A(7,2) + 0.50D0 * A(7,4)
              AIsym(7,5) = A(7,5)
              AIsym(7,6) = 0.50D0 * A(7,6) + 0.50D0 * A(7,8)
              AIsym(7,7) = 0.50D0 * A(7,3) + 0.50D0 * A(7,7)
              AIsym(7,8) = 0.50D0 * A(7,6) + 0.50D0 * A(7,8)
              AIsym(7,9) = A(7,9)
              AIsym(8,1) = A(8,1)
              AIsym(8,2) = 0.50D0 * A(8,2) + 0.50D0 * A(8,4)
              AIsym(8,3) = 0.50D0 * A(8,3) + 0.50D0 * A(8,7)
              AIsym(8,4) = 0.50D0 * A(8,2) + 0.50D0 * A(8,4)
              AIsym(8,5) = A(8,5)
              AIsym(8,6) = 0.50D0 * A(8,6) + 0.50D0 * A(8,8)
              AIsym(8,7) = 0.50D0 * A(8,3) + 0.50D0 * A(8,7)
              AIsym(8,8) = 0.50D0 * A(8,6) + 0.50D0 * A(8,8)
              AIsym(8,9) = A(8,9)
              AIsym(9,1) = A(9,1)
              AIsym(9,2) = 0.50D0 * A(9,2) + 0.50D0 * A(9,4)
              AIsym(9,3) = 0.50D0 * A(9,3) + 0.50D0 * A(9,7)
              AIsym(9,4) = 0.50D0 * A(9,2) + 0.50D0 * A(9,4)
              AIsym(9,5) = A(9,5)
              AIsym(9,6) = 0.50D0 * A(9,6) + 0.50D0 * A(9,8)
              AIsym(9,7) = 0.50D0 * A(9,3) + 0.50D0 * A(9,7)
              AIsym(9,8) = 0.50D0 * A(9,6) + 0.50D0 * A(9,8)
              AIsym(9,9) = A(9,9)

        end function
        !==========================================================================================

        !==========================================================================================
        function LeftSymmetrizationT4Voigt(A) result(IsymA)

            implicit none
            real(8),dimension(9,9) :: A, IsymA

            ! IsymA = Isym:A

              IsymA(1,1) = A(1,1)
              IsymA(1,2) = A(1,2)
              IsymA(1,3) = A(1,3)
              IsymA(1,4) = A(1,4)
              IsymA(1,5) = A(1,5)
              IsymA(1,6) = A(1,6)
              IsymA(1,7) = A(1,7)
              IsymA(1,8) = A(1,8)
              IsymA(1,9) = A(1,9)
              IsymA(2,1) = 0.50D0 * A(2,1) + 0.50D0 * A(4,1)
              IsymA(2,2) = 0.50D0 * A(2,2) + 0.50D0 * A(4,2)
              IsymA(2,3) = 0.50D0 * A(2,3) + 0.50D0 * A(4,3)
              IsymA(2,4) = 0.50D0 * A(2,4) + 0.50D0 * A(4,4)
              IsymA(2,5) = 0.50D0 * A(2,5) + 0.50D0 * A(4,5)
              IsymA(2,6) = 0.50D0 * A(2,6) + 0.50D0 * A(4,6)
              IsymA(2,7) = 0.50D0 * A(2,7) + 0.50D0 * A(4,7)
              IsymA(2,8) = 0.50D0 * A(2,8) + 0.50D0 * A(4,8)
              IsymA(2,9) = 0.50D0 * A(2,9) + 0.50D0 * A(4,9)
              IsymA(3,1) = 0.50D0 * A(3,1) + 0.50D0 * A(7,1)
              IsymA(3,2) = 0.50D0 * A(3,2) + 0.50D0 * A(7,2)
              IsymA(3,3) = 0.50D0 * A(3,3) + 0.50D0 * A(7,3)
              IsymA(3,4) = 0.50D0 * A(3,4) + 0.50D0 * A(7,4)
              IsymA(3,5) = 0.50D0 * A(3,5) + 0.50D0 * A(7,5)
              IsymA(3,6) = 0.50D0 * A(3,6) + 0.50D0 * A(7,6)
              IsymA(3,7) = 0.50D0 * A(3,7) + 0.50D0 * A(7,7)
              IsymA(3,8) = 0.50D0 * A(3,8) + 0.50D0 * A(7,8)
              IsymA(3,9) = 0.50D0 * A(3,9) + 0.50D0 * A(7,9)
              IsymA(4,1) = 0.50D0 * A(2,1) + 0.50D0 * A(4,1)
              IsymA(4,2) = 0.50D0 * A(2,2) + 0.50D0 * A(4,2)
              IsymA(4,3) = 0.50D0 * A(2,3) + 0.50D0 * A(4,3)
              IsymA(4,4) = 0.50D0 * A(2,4) + 0.50D0 * A(4,4)
              IsymA(4,5) = 0.50D0 * A(2,5) + 0.50D0 * A(4,5)
              IsymA(4,6) = 0.50D0 * A(2,6) + 0.50D0 * A(4,6)
              IsymA(4,7) = 0.50D0 * A(2,7) + 0.50D0 * A(4,7)
              IsymA(4,8) = 0.50D0 * A(2,8) + 0.50D0 * A(4,8)
              IsymA(4,9) = 0.50D0 * A(2,9) + 0.50D0 * A(4,9)
              IsymA(5,1) = A(5,1)
              IsymA(5,2) = A(5,2)
              IsymA(5,3) = A(5,3)
              IsymA(5,4) = A(5,4)
              IsymA(5,5) = A(5,5)
              IsymA(5,6) = A(5,6)
              IsymA(5,7) = A(5,7)
              IsymA(5,8) = A(5,8)
              IsymA(5,9) = A(5,9)
              IsymA(6,1) = 0.50D0 * A(6,1) + 0.50D0 * A(8,1)
              IsymA(6,2) = 0.50D0 * A(6,2) + 0.50D0 * A(8,2)
              IsymA(6,3) = 0.50D0 * A(6,3) + 0.50D0 * A(8,3)
              IsymA(6,4) = 0.50D0 * A(6,4) + 0.50D0 * A(8,4)
              IsymA(6,5) = 0.50D0 * A(6,5) + 0.50D0 * A(8,5)
              IsymA(6,6) = 0.50D0 * A(6,6) + 0.50D0 * A(8,6)
              IsymA(6,7) = 0.50D0 * A(6,7) + 0.50D0 * A(8,7)
              IsymA(6,8) = 0.50D0 * A(6,8) + 0.50D0 * A(8,8)
              IsymA(6,9) = 0.50D0 * A(6,9) + 0.50D0 * A(8,9)
              IsymA(7,1) = 0.50D0 * A(3,1) + 0.50D0 * A(7,1)
              IsymA(7,2) = 0.50D0 * A(3,2) + 0.50D0 * A(7,2)
              IsymA(7,3) = 0.50D0 * A(3,3) + 0.50D0 * A(7,3)
              IsymA(7,4) = 0.50D0 * A(3,4) + 0.50D0 * A(7,4)
              IsymA(7,5) = 0.50D0 * A(3,5) + 0.50D0 * A(7,5)
              IsymA(7,6) = 0.50D0 * A(3,6) + 0.50D0 * A(7,6)
              IsymA(7,7) = 0.50D0 * A(3,7) + 0.50D0 * A(7,7)
              IsymA(7,8) = 0.50D0 * A(3,8) + 0.50D0 * A(7,8)
              IsymA(7,9) = 0.50D0 * A(3,9) + 0.50D0 * A(7,9)
              IsymA(8,1) = 0.50D0 * A(6,1) + 0.50D0 * A(8,1)
              IsymA(8,2) = 0.50D0 * A(6,2) + 0.50D0 * A(8,2)
              IsymA(8,3) = 0.50D0 * A(6,3) + 0.50D0 * A(8,3)
              IsymA(8,4) = 0.50D0 * A(6,4) + 0.50D0 * A(8,4)
              IsymA(8,5) = 0.50D0 * A(6,5) + 0.50D0 * A(8,5)
              IsymA(8,6) = 0.50D0 * A(6,6) + 0.50D0 * A(8,6)
              IsymA(8,7) = 0.50D0 * A(6,7) + 0.50D0 * A(8,7)
              IsymA(8,8) = 0.50D0 * A(6,8) + 0.50D0 * A(8,8)
              IsymA(8,9) = 0.50D0 * A(6,9) + 0.50D0 * A(8,9)
              IsymA(9,1) = A(9,1)
              IsymA(9,2) = A(9,2)
              IsymA(9,3) = A(9,3)
              IsymA(9,4) = A(9,4)
              IsymA(9,5) = A(9,5)
              IsymA(9,6) = A(9,6)
              IsymA(9,7) = A(9,7)
              IsymA(9,8) = A(9,8)
              IsymA(9,9) = A(9,9)



        end function
        !==========================================================================================

        !==========================================================================================
        function RigthLeftSymmetrizationT4Voigt(A) result(IsAIs)

            implicit none
            real(8),dimension(9,9) :: A, IsAIs

            ! IsAIs = Isym:A:Isym

              IsAIs(1,1) = A(1,1)
              IsAIs(1,2) = 0.50D0 * A(1,2) + 0.50D0 * A(1,4)
              IsAIs(1,3) = 0.50D0 * A(1,3) + 0.50D0 * A(1,7)
              IsAIs(1,4) = 0.50D0 * A(1,2) + 0.50D0 * A(1,4)
              IsAIs(1,5) = A(1,5)
              IsAIs(1,6) = 0.50D0 * A(1,6) + 0.50D0 * A(1,8)
              IsAIs(1,7) = 0.50D0 * A(1,3) + 0.50D0 * A(1,7)
              IsAIs(1,8) = 0.50D0 * A(1,6) + 0.50D0 * A(1,8)
              IsAIs(1,9) = A(1,9)
              IsAIs(2,1) = 0.50D0 * A(2,1) + 0.50D0 * A(4,1)
              IsAIs(2,2) = 0.2500D0 * A(2,2) + 0.2500D0 * A(4,2) + 0.2500D0 * A(2,4) + 0.2500D0 * A(4,4)
              IsAIs(2,3) = 0.2500D0 * A(2,3) + 0.2500D0 * A(4,3) + 0.2500D0 * A(2,7) + 0.2500D0 * A(4,7)
              IsAIs(2,4) = 0.2500D0 * A(2,2) + 0.2500D0 * A(4,2) + 0.2500D0 * A(2,4) + 0.2500D0 * A(4,4)
              IsAIs(2,5) = 0.50D0 * A(2,5) + 0.50D0 * A(4,5)
              IsAIs(2,6) = 0.2500D0 * A(2,6) + 0.2500D0 * A(4,6) + 0.2500D0 * A(2,8) + 0.2500D0 * A(4,8)
              IsAIs(2,7) = 0.2500D0 * A(2,3) + 0.2500D0 * A(4,3) + 0.2500D0 * A(2,7) + 0.2500D0 * A(4,7)
              IsAIs(2,8) = 0.2500D0 * A(2,6) + 0.2500D0 * A(4,6) + 0.2500D0 * A(2,8) + 0.2500D0 * A(4,8)
              IsAIs(2,9) = 0.50D0 * A(2,9) + 0.50D0 * A(4,9)
              IsAIs(3,1) = 0.50D0 * A(3,1) + 0.50D0 * A(7,1)
              IsAIs(3,2) = 0.2500D0 * A(3,2) + 0.2500D0 * A(7,2) + 0.2500D0 * A(3,4) + 0.2500D0 * A(7,4)
              IsAIs(3,3) = 0.2500D0 * A(3,3) + 0.2500D0 * A(7,3) + 0.2500D0 * A(3,7) + 0.2500D0 * A(7,7)
              IsAIs(3,4) = 0.2500D0 * A(3,2) + 0.2500D0 * A(7,2) + 0.2500D0 * A(3,4) + 0.2500D0 * A(7,4)
              IsAIs(3,5) = 0.50D0 * A(3,5) + 0.50D0 * A(7,5)
              IsAIs(3,6) = 0.2500D0 * A(3,6) + 0.2500D0 * A(7,6) + 0.2500D0 * A(3,8) + 0.2500D0 * A(7,8)
              IsAIs(3,7) = 0.2500D0 * A(3,3) + 0.2500D0 * A(7,3) + 0.2500D0 * A(3,7) + 0.2500D0 * A(7,7)
              IsAIs(3,8) = 0.2500D0 * A(3,6) + 0.2500D0 * A(7,6) + 0.2500D0 * A(3,8) + 0.2500D0 * A(7,8)
              IsAIs(3,9) = 0.50D0 * A(3,9) + 0.50D0 * A(7,9)
              IsAIs(4,1) = 0.50D0 * A(2,1) + 0.50D0 * A(4,1)
              IsAIs(4,2) = 0.2500D0 * A(2,2) + 0.2500D0 * A(4,2) + 0.2500D0 * A(2,4) + 0.2500D0 * A(4,4)
              IsAIs(4,3) = 0.2500D0 * A(2,3) + 0.2500D0 * A(4,3) + 0.2500D0 * A(2,7) + 0.2500D0 * A(4,7)
              IsAIs(4,4) = 0.2500D0 * A(2,2) + 0.2500D0 * A(4,2) + 0.2500D0 * A(2,4) + 0.2500D0 * A(4,4)
              IsAIs(4,5) = 0.50D0 * A(2,5) + 0.50D0 * A(4,5)
              IsAIs(4,6) = 0.2500D0 * A(2,6) + 0.2500D0 * A(4,6) + 0.2500D0 * A(2,8) + 0.2500D0 * A(4,8)
              IsAIs(4,7) = 0.2500D0 * A(2,3) + 0.2500D0 * A(4,3) + 0.2500D0 * A(2,7) + 0.2500D0 * A(4,7)
              IsAIs(4,8) = 0.2500D0 * A(2,6) + 0.2500D0 * A(4,6) + 0.2500D0 * A(2,8) + 0.2500D0 * A(4,8)
              IsAIs(4,9) = 0.50D0 * A(2,9) + 0.50D0 * A(4,9)
              IsAIs(5,1) = A(5,1)
              IsAIs(5,2) = 0.50D0 * A(5,2) + 0.50D0 * A(5,4)
              IsAIs(5,3) = 0.50D0 * A(5,3) + 0.50D0 * A(5,7)
              IsAIs(5,4) = 0.50D0 * A(5,2) + 0.50D0 * A(5,4)
              IsAIs(5,5) = A(5,5)
              IsAIs(5,6) = 0.50D0 * A(5,6) + 0.50D0 * A(5,8)
              IsAIs(5,7) = 0.50D0 * A(5,3) + 0.50D0 * A(5,7)
              IsAIs(5,8) = 0.50D0 * A(5,6) + 0.50D0 * A(5,8)
              IsAIs(5,9) = A(5,9)
              IsAIs(6,1) = 0.50D0 * A(6,1) + 0.50D0 * A(8,1)
              IsAIs(6,2) = 0.2500D0 * A(6,2) + 0.2500D0 * A(8,2) + 0.2500D0 * A(6,4) + 0.2500D0 * A(8,4)
              IsAIs(6,3) = 0.2500D0 * A(6,3) + 0.2500D0 * A(8,3) + 0.2500D0 * A(6,7) + 0.2500D0 * A(8,7)
              IsAIs(6,4) = 0.2500D0 * A(6,2) + 0.2500D0 * A(8,2) + 0.2500D0 * A(6,4) + 0.2500D0 * A(8,4)
              IsAIs(6,5) = 0.50D0 * A(6,5) + 0.50D0 * A(8,5)
              IsAIs(6,6) = 0.2500D0 * A(6,6) + 0.2500D0 * A(8,6) + 0.2500D0 * A(6,8) + 0.2500D0 * A(8,8)
              IsAIs(6,7) = 0.2500D0 * A(6,3) + 0.2500D0 * A(8,3) + 0.2500D0 * A(6,7) + 0.2500D0 * A(8,7)
              IsAIs(6,8) = 0.2500D0 * A(6,6) + 0.2500D0 * A(8,6) + 0.2500D0 * A(6,8) + 0.2500D0 * A(8,8)
              IsAIs(6,9) = 0.50D0 * A(6,9) + 0.50D0 * A(8,9)
              IsAIs(7,1) = 0.50D0 * A(3,1) + 0.50D0 * A(7,1)
              IsAIs(7,2) = 0.2500D0 * A(3,2) + 0.2500D0 * A(7,2) + 0.2500D0 * A(3,4) + 0.2500D0 * A(7,4)
              IsAIs(7,3) = 0.2500D0 * A(3,3) + 0.2500D0 * A(7,3) + 0.2500D0 * A(3,7) + 0.2500D0 * A(7,7)
              IsAIs(7,4) = 0.2500D0 * A(3,2) + 0.2500D0 * A(7,2) + 0.2500D0 * A(3,4) + 0.2500D0 * A(7,4)
              IsAIs(7,5) = 0.50D0 * A(3,5) + 0.50D0 * A(7,5)
              IsAIs(7,6) = 0.2500D0 * A(3,6) + 0.2500D0 * A(7,6) + 0.2500D0 * A(3,8) + 0.2500D0 * A(7,8)
              IsAIs(7,7) = 0.2500D0 * A(3,3) + 0.2500D0 * A(7,3) + 0.2500D0 * A(3,7) + 0.2500D0 * A(7,7)
              IsAIs(7,8) = 0.2500D0 * A(3,6) + 0.2500D0 * A(7,6) + 0.2500D0 * A(3,8) + 0.2500D0 * A(7,8)
              IsAIs(7,9) = 0.50D0 * A(3,9) + 0.50D0 * A(7,9)
              IsAIs(8,1) = 0.50D0 * A(6,1) + 0.50D0 * A(8,1)
              IsAIs(8,2) = 0.2500D0 * A(6,2) + 0.2500D0 * A(8,2) + 0.2500D0 * A(6,4) + 0.2500D0 * A(8,4)
              IsAIs(8,3) = 0.2500D0 * A(6,3) + 0.2500D0 * A(8,3) + 0.2500D0 * A(6,7) + 0.2500D0 * A(8,7)
              IsAIs(8,4) = 0.2500D0 * A(6,2) + 0.2500D0 * A(8,2) + 0.2500D0 * A(6,4) + 0.2500D0 * A(8,4)
              IsAIs(8,5) = 0.50D0 * A(6,5) + 0.50D0 * A(8,5)
              IsAIs(8,6) = 0.2500D0 * A(6,6) + 0.2500D0 * A(8,6) + 0.2500D0 * A(6,8) + 0.2500D0 * A(8,8)
              IsAIs(8,7) = 0.2500D0 * A(6,3) + 0.2500D0 * A(8,3) + 0.2500D0 * A(6,7) + 0.2500D0 * A(8,7)
              IsAIs(8,8) = 0.2500D0 * A(6,6) + 0.2500D0 * A(8,6) + 0.2500D0 * A(6,8) + 0.2500D0 * A(8,8)
              IsAIs(8,9) = 0.50D0 * A(6,9) + 0.50D0 * A(8,9)
              IsAIs(9,1) = A(9,1)
              IsAIs(9,2) = 0.50D0 * A(9,2) + 0.50D0 * A(9,4)
              IsAIs(9,3) = 0.50D0 * A(9,3) + 0.50D0 * A(9,7)
              IsAIs(9,4) = 0.50D0 * A(9,2) + 0.50D0 * A(9,4)
              IsAIs(9,5) = A(9,5)
              IsAIs(9,6) = 0.50D0 * A(9,6) + 0.50D0 * A(9,8)
              IsAIs(9,7) = 0.50D0 * A(9,3) + 0.50D0 * A(9,7)
              IsAIs(9,8) = 0.50D0 * A(9,6) + 0.50D0 * A(9,8)
              IsAIs(9,9) = A(9,9)

        end function
        !==========================================================================================

        !##################################################################################################
        !
        ! Operations using symmetric mapping
        !
        !##################################################################################################
        !==========================================================================================
        function BallVoigtSym(Av,Bv) result(D)

            implicit none
            real(8),dimension(6)   :: Av,Bv
            real(8),dimension(6,6) :: D

              D(1,1) = Av(1) * Bv(1)
              D(1,2) = Av(1) * Bv(2)
              D(1,3) = Av(1) * Bv(3)
              D(1,4) = Av(1) * Bv(4)
              D(1,5) = Av(1) * Bv(5)
              D(1,6) = Av(1) * Bv(6)
              D(2,1) = Av(2) * Bv(1)
              D(2,2) = Av(2) * Bv(2)
              D(2,3) = Av(2) * Bv(3)
              D(2,4) = Av(2) * Bv(4)
              D(2,5) = Av(2) * Bv(5)
              D(2,6) = Av(2) * Bv(6)
              D(3,1) = Av(3) * Bv(1)
              D(3,2) = Av(3) * Bv(2)
              D(3,3) = Av(3) * Bv(3)
              D(3,4) = Av(3) * Bv(4)
              D(3,5) = Av(3) * Bv(5)
              D(3,6) = Av(3) * Bv(6)
              D(4,1) = Av(4) * Bv(1)
              D(4,2) = Av(4) * Bv(2)
              D(4,3) = Av(4) * Bv(3)
              D(4,4) = Av(4) * Bv(4)
              D(4,5) = Av(4) * Bv(5)
              D(4,6) = Av(4) * Bv(6)
              D(5,1) = Av(5) * Bv(1)
              D(5,2) = Av(5) * Bv(2)
              D(5,3) = Av(5) * Bv(3)
              D(5,4) = Av(5) * Bv(4)
              D(5,5) = Av(5) * Bv(5)
              D(5,6) = Av(5) * Bv(6)
              D(6,1) = Av(6) * Bv(1)
              D(6,2) = Av(6) * Bv(2)
              D(6,3) = Av(6) * Bv(3)
              D(6,4) = Av(6) * Bv(4)
              D(6,5) = Av(6) * Bv(5)
              D(6,6) = Av(6) * Bv(6)


        end function
        !==========================================================================================

        !==========================================================================================
        function SquareVoigtSym(Av,Bv) result(D)

            implicit none
            real(8),dimension(6)   :: Av,Bv
            real(8),dimension(6,6) :: D

              D(1,1) = Av(1) * Bv(1)
              D(1,2) = Av(4) * Bv(4)
              D(1,3) = Av(6) * Bv(6)
              D(1,4) = Av(1) * Bv(4) / 0.2D1 + Av(4) * Bv(1) / 0.2D1
              D(1,5) = Av(4) * Bv(6) / 0.2D1 + Av(6) * Bv(4) / 0.2D1
              D(1,6) = Av(1) * Bv(6) / 0.2D1 + Av(6) * Bv(1) / 0.2D1
              D(2,1) = Av(4) * Bv(4)
              D(2,2) = Av(2) * Bv(2)
              D(2,3) = Av(5) * Bv(5)
              D(2,4) = Av(4) * Bv(2) / 0.2D1 + Av(2) * Bv(4) / 0.2D1
              D(2,5) = Av(2) * Bv(5) / 0.2D1 + Av(5) * Bv(2) / 0.2D1
              D(2,6) = Av(4) * Bv(5) / 0.2D1 + Av(5) * Bv(4) / 0.2D1
              D(3,1) = Av(6) * Bv(6)
              D(3,2) = Av(5) * Bv(5)
              D(3,3) = Av(3) * Bv(3)
              D(3,4) = Av(6) * Bv(5) / 0.2D1 + Av(5) * Bv(6) / 0.2D1
              D(3,5) = Av(5) * Bv(3) / 0.2D1 + Av(3) * Bv(5) / 0.2D1
              D(3,6) = Av(6) * Bv(3) / 0.2D1 + Av(3) * Bv(6) / 0.2D1
              D(4,1) = Av(1) * Bv(4) / 0.2D1 + Av(4) * Bv(1) / 0.2D1
              D(4,2) = Av(4) * Bv(2) / 0.2D1 + Av(2) * Bv(4) / 0.2D1
              D(4,3) = Av(6) * Bv(5) / 0.2D1 + Av(5) * Bv(6) / 0.2D1
              D(4,4) = Av(1) * Bv(2) / 0.4D1 + Av(4) * Bv(4) / 0.2D1 + Av(2) * Bv(1) / 0.4D1
              D(4,5) = Av(4) * Bv(5) / 0.4D1 + Av(2) * Bv(6) / 0.4D1 + Av(6) * Bv(2) / 0.4D1 + Av(5) * Bv(4) / 0.4D1
              D(4,6) = Av(1) * Bv(5) / 0.4D1 + Av(4) * Bv(6) / 0.4D1 + Av(6) * Bv(4) / 0.4D1 + Av(5) * Bv(1) / 0.4D1
              D(5,1) = Av(4) * Bv(6) / 0.2D1 + Av(6) * Bv(4) / 0.2D1
              D(5,2) = Av(2) * Bv(5) / 0.2D1 + Av(5) * Bv(2) / 0.2D1
              D(5,3) = Av(5) * Bv(3) / 0.2D1 + Av(3) * Bv(5) / 0.2D1
              D(5,4) = Av(4) * Bv(5) / 0.4D1 + Av(2) * Bv(6) / 0.4D1 + Av(6) * Bv(2) / 0.4D1 + Av(5) * Bv(4) / 0.4D1
              D(5,5) = Av(2) * Bv(3) / 0.4D1 + Av(5) * Bv(5) / 0.2D1 + Av(3) * Bv(2) / 0.4D1
              D(5,6) = Av(4) * Bv(3) / 0.4D1 + Av(5) * Bv(6) / 0.4D1 + Av(6) * Bv(5) / 0.4D1 + Av(3) * Bv(4) / 0.4D1
              D(6,1) = Av(1) * Bv(6) / 0.2D1 + Av(6) * Bv(1) / 0.2D1
              D(6,2) = Av(4) * Bv(5) / 0.2D1 + Av(5) * Bv(4) / 0.2D1
              D(6,3) = Av(6) * Bv(3) / 0.2D1 + Av(3) * Bv(6) / 0.2D1
              D(6,4) = Av(1) * Bv(5) / 0.4D1 + Av(4) * Bv(6) / 0.4D1 + Av(6) * Bv(4) / 0.4D1 + Av(5) * Bv(1) / 0.4D1
              D(6,5) = Av(4) * Bv(3) / 0.4D1 + Av(5) * Bv(6) / 0.4D1 + Av(6) * Bv(5) / 0.4D1 + Av(3) * Bv(4) / 0.4D1
              D(6,6) = Av(1) * Bv(3) / 0.4D1 + Av(6) * Bv(6) / 0.2D1 + Av(3) * Bv(1) / 0.4D1


        end function
        !==========================================================================================

        !==========================================================================================
        function DoubleContractionT2T2VoigtSym(Av,Bv) result(s)

            implicit none
            real(8),dimension(6)   :: Av,Bv
            real(8)                :: s

            s = Av(1)*Bv(1) + Av(2)*Bv(2) + Av(3)*Bv(3) + &
                2.0d0*Av(4)*Bv(4) + 2.0d0*Av(5)*Bv(5) + 2.0d0*Av(6)*Bv(6)

        end function
        !==========================================================================================

        !==========================================================================================
        function DoubleContractionT4T2VoigtSym(Cv,Av) result(Bv)

            implicit none
            real(8),dimension(6,6) :: Cv
            real(8),dimension(6)   :: Av,Bv

              Bv(1) = Cv(1,1) * Av(1) + Cv(1,2) * Av(2) + Cv(1,3) * Av(3) + &
                        2.0d0 * Cv(1,4) * Av(4) + 2.0d0 * Cv(1,5) * Av(5) + 2.0d0 * Cv(1,6) * Av(6)
              Bv(2) = Cv(2,1) * Av(1) + Cv(2,2) * Av(2) + Cv(2,3) * Av(3) + &
                        2.0d0 * Cv(2,4) * Av(4) + 2.0d0 * Cv(2,5) * Av(5) + 2.0d0 * Cv(2,6) * Av(6)
              Bv(3) = Cv(3,1) * Av(1) + Cv(3,2) * Av(2) + Cv(3,3) * Av(3) + &
                        2.0d0 * Cv(3,4) * Av(4) + 2.0d0 * Cv(3,5) * Av(5) + 2.0d0 * Cv(3,6) * Av(6)
              Bv(4) = Cv(4,1) * Av(1) + Cv(4,2) * Av(2) + Cv(4,3) * Av(3) + &
                        2.0d0 * Cv(4,4) * Av(4) + 2.0d0 * Cv(4,5) * Av(5) + 2.0d0 * Cv(4,6) * Av(6)
              Bv(5) = Cv(5,1) * Av(1) + Cv(5,2) * Av(2) + Cv(5,3) * Av(3) + &
                        2.0d0 * Cv(5,4) * Av(4) + 2.0d0 * Cv(5,5) * Av(5) + 2.0d0 * Cv(5,6) * Av(6)
              Bv(6) = Cv(6,1) * Av(1) + Cv(6,2) * Av(2) + Cv(6,3) * Av(3) + &
                        2.0d0 * Cv(6,4) * Av(4) + 2.0d0 * Cv(6,5) * Av(5) + 2.0d0 * Cv(6,6) * Av(6)

        end function
        !==========================================================================================

        !==========================================================================================
        function DoubleContractionT4T4VoigtSym(Cv,Dv) result(Ev)

            implicit none
            real(8),dimension(6,6) :: Cv,Dv,Ev

                Ev = Dv

                Ev(4:6,:) = 2.0d0*Ev(4:6,:)

                Ev = matmul(Cv,Ev)

        end function
        !==========================================================================================

        !==========================================================================================
        function IdentityT4SymVoigtSym() result(T)

            real(8),dimension(6,6) :: T

            T = 0.0d0
            T(1,1) = 1.0d0
            T(2,2) = 1.0d0
            T(3,3) = 1.0d0
            T(4,4) = 0.50d0
            T(5,5) = 0.50d0
            T(6,6) = 0.50d0

        end function
        !==========================================================================================

        !==========================================================================================
        function IdentityT4SymInvVoigtSym() result(T)

            real(8),dimension(6,6) :: T

            T = 0.0d0
            T(1,1) = 1.0d0
            T(2,2) = 1.0d0
            T(3,3) = 1.0d0
            T(4,4) = 2.0d0
            T(5,5) = 2.0d0
            T(6,6) = 2.0d0

        end function
        !==========================================================================================

        !==========================================================================================
        function MaterialToSpatialModulusVoigtSym(Dmaterial,F) result(Dspatial)

            implicit none
            real(8) :: J
            real(8),dimension(:,:) :: Dmaterial
            real(8),dimension(3,3) :: F, Ft
            real(8),dimension(6,6) :: Dspatial, A, ADmaterial

              J = DeterminantT2(F)

              Ft = transpose(F)

              A(1,1) = Ft(1,1) ** 2.0d0
              A(1,2) = Ft(2,1) ** 2.0d0
              A(1,3) = Ft(3,1) ** 2.0d0
              A(1,4) = 2.0d0 * Ft(1,1) * Ft(2,1)
              A(1,5) = 2.0d0 * Ft(2,1) * Ft(3,1)
              A(1,6) = 2.0d0 * Ft(1,1) * Ft(3,1)
              A(2,1) = Ft(1,2) ** 2.0d0
              A(2,2) = Ft(2,2) ** 2.0d0
              A(2,3) = Ft(3,2) ** 2.0d0
              A(2,4) = 2.0d0 * Ft(1,2) * Ft(2,2)
              A(2,5) = 2.0d0 * Ft(2,2) * Ft(3,2)
              A(2,6) = 2.0d0 * Ft(1,2) * Ft(3,2)
              A(3,1) = Ft(1,3) ** 2.0d0
              A(3,2) = Ft(2,3) ** 2.0d0
              A(3,3) = Ft(3,3) ** 2.0d0
              A(3,4) = 2.0d0 * Ft(1,3) * Ft(2,3)
              A(3,5) = 2.0d0 * Ft(2,3) * Ft(3,3)
              A(3,6) = 2.0d0 * Ft(1,3) * Ft(3,3)
              A(4,1) = Ft(1,1) * Ft(1,2)
              A(4,2) = Ft(2,1) * Ft(2,2)
              A(4,3) = Ft(3,1) * Ft(3,2)
              A(4,4) = Ft(1,1) * Ft(2,2) + Ft(2,1) * Ft(1,2)
              A(4,5) = Ft(2,1) * Ft(3,2) + Ft(3,1) * Ft(2,2)
              A(4,6) = Ft(3,1) * Ft(1,2) + Ft(1,1) * Ft(3,2)
              A(5,1) = Ft(1,2) * Ft(1,3)
              A(5,2) = Ft(2,2) * Ft(2,3)
              A(5,3) = Ft(3,2) * Ft(3,3)
              A(5,4) = Ft(1,2) * Ft(2,3) + Ft(2,2) * Ft(1,3)
              A(5,5) = Ft(2,2) * Ft(3,3) + Ft(3,2) * Ft(2,3)
              A(5,6) = Ft(3,2) * Ft(1,3) + Ft(1,2) * Ft(3,3)
              A(6,1) = Ft(1,1) * Ft(1,3)
              A(6,2) = Ft(2,1) * Ft(2,3)
              A(6,3) = Ft(3,1) * Ft(3,3)
              A(6,4) = Ft(1,3) * Ft(2,1) + Ft(2,3) * Ft(1,1)
              A(6,5) = Ft(2,3) * Ft(3,1) + Ft(3,3) * Ft(2,1)
              A(6,6) = Ft(3,3) * Ft(1,1) + Ft(1,3) * Ft(3,1)

              !Dspatial = matmul(A, matmul(Dmaterial,transpose(A)) )/J

              call dsymm('R', 'U', 6, 6, 1.0d0, Dmaterial, 6, A, 6, 0.0d0, ADmaterial, 6)

              call dgemm('N', 'T', 6, 6, 6, 1.0d0/J, ADmaterial, 6, A,  6, 0.0d0, Dspatial, 6)


        end function
        !==========================================================================================

end module
